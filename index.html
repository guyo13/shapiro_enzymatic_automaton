<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecular Finite Automaton Simulator</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #475569;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --dna-back: #e2e8f0;
            --accent-q0: #10b981;
            /* Green for q0 */
            --accent-q1: #f59e0b;
            /* Amber for q1 */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: #1e293b;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--secondary);
            font-weight: 300;
        }

        /* Layout Grid */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h2 {
            font-size: 1.25rem;
            margin-top: 0;
            border-bottom: 2px solid var(--dna-back);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* Config Forms */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .transition-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            background: #f1f5f9;
            padding: 8px;
            border-radius: 6px;
        }

        .transition-arrow {
            font-weight: bold;
            color: var(--secondary);
            margin: 0 10px;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #1d4ed8;
        }

        button:disabled {
            background-color: #cbd5e1;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--secondary);
        }

        /* Visualization Area */
        #viz-container {
            grid-column: 1 / -1;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            width: 100%;
        }

        #canvas-area {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .status-bar {
            background: #334155;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            font-family: monospace;
        }

        /* DNA Styling */
        .dna-wrapper {
            display: flex;
            align-items: flex-start;
            margin-top: 20px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 18px;
            position: relative;
            min-width: max-content;
        }

        .dna-symbol {
            display: flex;
            flex-direction: column;
            margin-right: 2px;
            position: relative;
        }

        .dna-strand {
            padding: 4px 2px;
            letter-spacing: 2px;
            height: 24px;
            display: flex;
            align-items: center;
        }

        .strand-top {
            background-color: #e0f2fe;
            border-bottom: 1px solid #94a3b8;
            color: #0369a1;
        }

        .strand-bottom {
            background-color: #f0f9ff;
            border-top: 1px solid #94a3b8;
            color: #0ea5e9;
        }

        /* Sticky End Highlighting */
        .sticky-highlight {
            background-color: #fef08a !important;
            /* Yellow highlight */
            border: 2px solid #eab308;
            z-index: 10;
        }

        .cut-off {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .enzyme-block {
            position: absolute;
            top: -40px;
            left: 0;
            background: rgba(255, 99, 71, 0.2);
            border: 2px dashed tomato;
            padding: 5px;
            border-radius: 4px;
            pointer-events: none;
            white-space: nowrap;
            font-size: 12px;
            color: tomato;
        }

        /* Reference Table Styling */
        .ref-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .ref-table th,
        .ref-table td {
            border: 1px solid #e2e8f0;
            padding: 6px;
            text-align: center;
        }

        .ref-table th {
            background: #f8fafc;
        }

        .dna-code {
            font-family: monospace;
            color: #334155;
            letter-spacing: 1px;
        }

        .underline-offset-0 {
            /* Simulating underline for first 4 chars */
            position: relative;
        }

        .underline-offset-0::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 0;
            width: 66%;
            /* approx 4 chars out of 6 */
            height: 3px;
            background: red;
        }

        .underline-offset-2 {
            /* Simulating underline for last 4 chars */
            position: relative;
        }

        .underline-offset-2::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 0;
            width: 66%;
            /* approx 4 chars out of 6 */
            height: 3px;
            background: red;
        }

        .state-badge {
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 0.8em;
        }

        .bg-q0 {
            background-color: var(--accent-q0);
        }

        .bg-q1 {
            background-color: var(--accent-q1);
        }

        /* Transition Molecule Styling */
        .transition-molecule {
            display: flex;
            flex-direction: column;
            margin-right: 8px;
            padding: 4px;
            border: 2px solid #6366f1;
            border-radius: 8px;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            position: relative;
        }

        .transition-molecule::after {
            content: '‚ü∂';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: #6366f1;
        }

        .transition-label {
            font-size: 10px;
            text-align: center;
            color: #4338ca;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .foki-recognition {
            background-color: #fee2e2 !important;
            border: 1px solid #ef4444 !important;
            color: #b91c1c !important;
        }

        .spacer-region {
            background-color: #dcfce7 !important;
            border: 1px solid #22c55e !important;
            color: #166534 !important;
        }

        .binding-complement {
            background-color: #dbeafe !important;
            border: 1px solid #3b82f6 !important;
            color: #1e40af !important;
        }

        .cut-marker {
            position: absolute;
            width: 2px;
            background: #dc2626;
            z-index: 20;
        }

        .cut-marker::before {
            content: '‚úÇ';
            position: absolute;
            top: -18px;
            left: -6px;
            font-size: 12px;
            color: #dc2626;
        }

        .cut-marker-top {
            height: 28px;
            top: 18px;
        }

        .cut-marker-bottom {
            height: 28px;
            top: 46px;
        }

        .phase-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .phase-binding {
            background-color: #c7d2fe;
            color: #3730a3;
        }

        .phase-aftercut {
            background-color: #fef08a;
            color: #854d0e;
        }

        .phase-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: nowrap;
            white-space: nowrap;
        }

        /* GitHub Corner */
        .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out
        }

        @keyframes octocat-wave {

            0%,
            100% {
                transform: rotate(0)
            }

            20%,
            60% {
                transform: rotate(-25deg)
            }

            40%,
            80% {
                transform: rotate(10deg)
            }
        }

        @media (max-width:500px) {
            .github-corner:hover .octo-arm {
                animation: none
            }

            .github-corner .octo-arm {
                animation: octocat-wave 560ms ease-in-out
            }
        }
    </style>
</head>

<body>
    <a href="https://github.com/guyo13/shapiro_enzymatic_automaton" class="github-corner"
        aria-label="View source on GitHub" target="_blank" rel="noopener noreferrer">
        <svg width="80" height="80" viewBox="0 0 250 250"
            style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path
                d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.5 120.5,78.5 C116.4,72.3 121.2,74.1 121.2,74.1 C124.5,75.0 123.0,75.7 123.0,75.7 C117.2,82.5 123.0,89.6 123.0,89.6 C122.1,110.5 122.5,120.5 122.6,126.6"
                fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path
                d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.3 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                fill="currentColor" class="octo-body"></path>
        </svg>
    </a>

    <div class="container">
        <h1>Enzymatic Automaton Simulator</h1>

        <div class="dashboard">
            <!-- Configuration -->
            <div class="card">
                <h2>1. Configure Automaton</h2>

                <div class="form-group">
                    <label>Transition Rules:</label>
                    <div class="transition-row">
                        <span class="state-badge bg-q0">q0</span> + 'a' <span class="transition-arrow">&rarr;</span>
                        <select id="trans-q0-a">
                            <option value="q0">q0</option>
                            <option value="q1">q1</option>
                        </select>
                    </div>
                    <div class="transition-row">
                        <span class="state-badge bg-q0">q0</span> + 'b' <span class="transition-arrow">&rarr;</span>
                        <select id="trans-q0-b">
                            <option value="q0">q0</option>
                            <option value="q1" selected>q1</option>
                        </select>
                    </div>
                    <div class="transition-row">
                        <span class="state-badge bg-q1">q1</span> + 'a' <span class="transition-arrow">&rarr;</span>
                        <select id="trans-q1-a">
                            <option value="q0">q0</option>
                            <option value="q1" selected>q1</option>
                        </select>
                    </div>
                    <div class="transition-row">
                        <span class="state-badge bg-q1">q1</span> + 'b' <span class="transition-arrow">&rarr;</span>
                        <select id="trans-q1-b">
                            <option value="q0" selected>q0</option>
                            <option value="q1">q1</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Initial State:</label>
                    <select id="initial-state">
                        <option value="q0">q0</option>
                        <option value="q1">q1</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Input String (a, b):</label>
                    <input type="text" id="input-string" value="abb" placeholder="e.g. abaab">
                </div>

                <button onclick="initSimulation()">Load Simulation</button>
            </div>

            <!-- Reference -->
            <div class="card">
                <h2>2. Symbol-State Reference</h2>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                    <strong>Key Rule:</strong> Target State determines the cleavage offset for the <em>next</em> symbol.
                    <br>q0 &rarr; Offset 2 (read bases 3-6)
                    <br>q1 &rarr; Offset 0 (read bases 1-4)
                </p>
                <table class="ref-table">
                    <thead>
                        <tr>
                            <th>State / Offset</th>
                            <th>'a'<br><small>CTGGCT</small></th>
                            <th>'b'<br><small>CGCAGC</small></th>
                            <th>'t'<br><small>TGTCGC</small></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>q0</strong> (&Delta;=2)<br><small>Reads last 4</small></td>
                            <td><span class="dna-code underline-offset-2">CTGGCT</span></td>
                            <td><span class="dna-code underline-offset-2">CGCAGC</span></td>
                            <td><span class="dna-code underline-offset-2">TGTCGC</span></td>
                        </tr>
                        <tr>
                            <td><strong>q1</strong> (&Delta;=0)<br><small>Reads first 4</small></td>
                            <td><span class="dna-code underline-offset-0">CTGGCT</span></td>
                            <td><span class="dna-code underline-offset-0">CGCAGC</span></td>
                            <td><span class="dna-code underline-offset-0">TGTCGC</span></td>
                        </tr>
                    </tbody>
                </table>
                <div
                    style="margin-top: 15px; font-size: 0.8rem; border: 1px solid #fbbf24; background: #fffbeb; padding: 10px; border-radius: 4px;">
                    <strong>Simulation Note:</strong> The "Sticky End" shown in yellow is the active part of the input
                    molecule waiting to be bound by a transition molecule.
                    Bases marked in red mark the ends of the Fok1 cleavage site.
                </div>
            </div>
        </div>

        <!-- Visualization -->
        <div class="card" id="viz-container">
            <h2>3. Molecular Visualization</h2>

            <div class="controls">
                <button class="btn-secondary" id="btn-prev" onclick="step(-1)" disabled>&larr; Back</button>
                <div style="display:flex; align-items:center; font-weight:bold; padding: 0 10px;">
                    Step: <span id="step-count" style="margin-left:5px">0</span>
                </div>
                <button class="btn-secondary" id="btn-next" onclick="step(1)" disabled>Next &rarr;</button>
            </div>

            <div class="status-bar">
                <div>Current State: <span id="current-state-display" style="font-weight:bold; color: white;">-</span>
                </div>
                <div>Reading Symbol: <span id="current-symbol-display" style="font-weight:bold">-</span></div>
                <div>Action: <span id="action-display">-</span></div>
            </div>

            <div id="canvas-area"
                style="width: 100%; overflow-x: auto; min-height: 150px; display: flex;flex-direction: column;">
                <!-- DNA visualization will be injected here -->
                <div style="color: #94a3b8; margin-top: 40px;">Click "Load Simulation" to begin</div>
            </div>
        </div>
    </div>

    <script>
        // Constants based on user image/textbook
        const DNA_MAP = {
            'a': { seq: 'CTGGCT', comp: 'GACCGA' },
            'b': { seq: 'CGCAGC', comp: 'GCGTCG' },
            't': { seq: 'TGTCGC', comp: 'ACAGCG' } // Terminator
        };

        // User Rule: Target State determines Offset of resulting cut
        const STATE_OFFSETS = {
            'q0': 2, // Reading bases 3-6 (indices 2-5)
            'q1': 0  // Reading bases 1-4 (indices 0-3)
        };

        // Transition molecules from Figure 5.22 (Shapiro paper)
        // Structure: [FokI GGATG] - [Spacer 1/3/5 bases] - [Complementary sticky end on bottom overhang]
        const TRANSITION_MOLECULES = {
            'q0': {
                'a': {
                    'q0': { id: 'T1', top: 'GGATGTAC', bottom: 'CCTACATGCCGA', spacerLen: 3 },
                    'q1': { id: 'T2', top: 'GGATGACGAC', bottom: 'CCTACTGCTGCCGA', spacerLen: 5 }
                },
                'b': {
                    'q0': { id: 'T3', top: 'GGATGACG', bottom: 'CCTACTGCGTCG', spacerLen: 3 },
                    'q1': { id: 'T4', top: 'GGATGACGAC', bottom: 'CCTACTGCTGGTCG', spacerLen: 5 }
                }
            },
            'q1': {
                'a': {
                    'q0': { id: 'T5', top: 'GGATGA', bottom: 'CCTACTGACC', spacerLen: 1 },
                    'q1': { id: 'T6', top: 'GGATGACG', bottom: 'CCTACTGCGACC', spacerLen: 3 }
                },
                'b': {
                    'q0': { id: 'T7', top: 'GGATGG', bottom: 'CCTACCGCGT', spacerLen: 1 },
                    'q1': { id: 'T8', top: 'GGATGACG', bottom: 'CCTACTGCGCGT', spacerLen: 3 }
                }
            }
        };

        // FokI cuts 9 bases after recognition site (5' strand), 13 bases (3' strand)
        const FOKI_CUT_5 = 9;
        const FOKI_CUT_3 = 13;
        const FOKI_SITE = 'GGATG';

        // Simulation State
        let simulationSteps = [];
        let currentStepIndex = 0;
        let transitionTable = {};

        function initSimulation() {
            // 1. Gather Configuration
            const startState = document.getElementById('initial-state').value;
            const inputStr = document.getElementById('input-string').value.toLowerCase().replace(/[^ab]/g, '') + 't'; // Add terminator

            transitionTable = {
                'q0': {
                    'a': document.getElementById('trans-q0-a').value,
                    'b': document.getElementById('trans-q0-b').value,
                    't': 'HALT'
                },
                'q1': {
                    'a': document.getElementById('trans-q1-a').value,
                    'b': document.getElementById('trans-q1-b').value,
                    't': 'HALT'
                }
            };

            // 2. Pre-calculate all simulation steps
            simulationSteps = [];
            let currentState = startState;
            let currentOffset = STATE_OFFSETS[currentState];

            // Generate initial full DNA string data structure
            let symbolsData = [];
            for (let char of inputStr) {
                symbolsData.push({
                    char: char,
                    seq: DNA_MAP[char].seq,
                    comp: DNA_MAP[char].comp,
                    status: 'pending'
                });
            }

            // Loop through input symbols
            for (let i = 0; i < inputStr.length; i++) {
                const char = inputStr[i];

                // Check for termination
                if (char === 't') {
                    // Final step - terminator reached
                    let finalSyms = JSON.parse(JSON.stringify(symbolsData));
                    finalSyms[i].status = 'active';
                    simulationSteps.push({
                        stepNum: simulationSteps.length,
                        stepType: 'complete',
                        state: currentState,
                        symbolIndex: i,
                        offset: currentOffset,
                        symbols: finalSyms,
                        action: "Terminator reached. Computation complete!",
                        transitionMolecule: null
                    });
                    break;
                }

                const nextState = transitionTable[currentState][char];
                const nextOffset = STATE_OFFSETS[nextState];
                const molecule = TRANSITION_MOLECULES[currentState][char][nextState];

                // Step A: BINDING - Show transition molecule attached
                let bindingSyms = JSON.parse(JSON.stringify(symbolsData));
                bindingSyms[i].status = 'active';

                simulationSteps.push({
                    stepNum: simulationSteps.length,
                    stepType: 'binding',
                    state: currentState,
                    nextState: nextState,
                    symbolIndex: i,
                    offset: currentOffset,
                    nextOffset: nextOffset,
                    symbols: bindingSyms,
                    action: `${molecule.id}: (${currentState}, ${char}) ‚Üí ${nextState}. FokI will cut after 9 bases.`,
                    transitionMolecule: molecule,
                    inputChar: char
                });

                // Step B: AFTER CUT - Show DNA after FokI cleavage
                let afterCutSyms = JSON.parse(JSON.stringify(symbolsData));
                afterCutSyms[i].status = 'digested';
                if (i + 1 < inputStr.length) {
                    afterCutSyms[i + 1].status = 'active';
                }

                simulationSteps.push({
                    stepNum: simulationSteps.length,
                    stepType: 'afterCut',
                    state: nextState,
                    symbolIndex: i + 1,
                    offset: nextOffset,
                    symbols: afterCutSyms,
                    action: `Cut complete. Now in state ${nextState}. New sticky end exposed.`,
                    transitionMolecule: null,
                    inputChar: inputStr[i + 1] || 't'
                });

                // Update for next iteration
                symbolsData = afterCutSyms;
                currentState = nextState;
                currentOffset = nextOffset;
            }

            // 3. Reset View
            currentStepIndex = 0;
            renderStep();
            updateControls();
        }

        function step(delta) {
            currentStepIndex += delta;
            if (currentStepIndex < 0) currentStepIndex = 0;
            if (currentStepIndex >= simulationSteps.length) currentStepIndex = simulationSteps.length - 1;
            renderStep();
            updateControls();
        }

        function updateControls() {
            document.getElementById('btn-prev').disabled = currentStepIndex === 0;
            document.getElementById('btn-next').disabled = currentStepIndex === simulationSteps.length - 1;
            document.getElementById('step-count').innerText = currentStepIndex;
        }

        function renderStep() {
            const data = simulationSteps[currentStepIndex];
            const canvas = document.getElementById('canvas-area');

            // Update Status Bar
            const stateSpan = document.getElementById('current-state-display');
            stateSpan.innerText = data.state;
            stateSpan.className = data.state === 'q0' ? 'state-badge bg-q0' : 'state-badge bg-q1';

            const sym = data.symbolIndex < data.symbols.length ? data.symbols[data.symbolIndex].char : 't';
            document.getElementById('current-symbol-display').innerText = sym;
            document.getElementById('action-display').innerText = data.action;

            // Build DNA Visual
            let html = '<div class="dna-wrapper">';

            // Render Transition Molecule if in binding phase
            if (data.stepType === 'binding' && data.transitionMolecule) {
                html += renderTransitionMolecule(data.transitionMolecule, data.symbols, data.symbolIndex, data.offset);
            }

            // Render input DNA symbols
            data.symbols.forEach((sym, idx) => {
                const isCurrent = idx === data.symbolIndex;
                const isDigested = idx < data.symbolIndex;
                const isBindingPhase = data.stepType === 'binding';
                const isNextSymbol = isBindingPhase && idx === data.symbolIndex + 1;

                let opacityClass = isDigested ? 'cut-off' : '';

                let topHtml = '';
                let botHtml = '';

                // Render base by base to control styling
                for (let b = 0; b < 6; b++) {
                    let isSticky = false;
                    let isCutPosition = false;
                    let isCleavedTop = false;
                    let isCleavedBottom = false;

                    if (isCurrent) {
                        // Determine sticky end region based on current offset
                        if (data.offset === 0) {
                            if (b < 4) isSticky = true;
                        } else if (data.offset === 2) {
                            if (b >= 2) isSticky = true;
                        }
                    }

                    // In binding phase, highlight the portion of next symbol that will be CLEAVED OFF
                    // This is the DNA that gets discarded along with the transition molecule
                    if (isNextSymbol && data.nextOffset !== undefined) {
                        if (data.nextOffset === 2) {
                            // Going to q0: cut at position 2
                            // Top strand: bases 0-1 get cleaved off
                            // Bottom strand: ALL bases get cleaved (staggered cut)
                            if (b < 2) isCleavedTop = true;
                            isCleavedBottom = true; // All bottom bases cleaved
                        } else if (data.nextOffset === 0) {
                            // Going to q1: cut at position 0
                            // Top strand: no bases cleaved (sticky end starts at 0)
                            // Bottom strand: bases 0-3 get cleaved (under the overhang)
                            if (b < 4) isCleavedBottom = true;
                        }
                    }

                    // Check if this base should be grayed out (cut off portion)
                    // In afterCut, binding, or complete phase with offset=2, the first 2 bases were cut off
                    const isCutOff = isCurrent && (data.stepType === 'afterCut' || data.stepType === 'binding' || data.stepType === 'complete') && data.offset === 2 && b < 2;

                    let topStyle = '';
                    let botStyle = '';

                    if (isCutOff) {
                        topStyle = 'opacity:0.3; filter:grayscale(100%);';
                        botStyle = 'opacity:0.3; filter:grayscale(100%);';
                    } else if (isSticky) {
                        topStyle = 'background-color:#fef08a; border:1px solid #eab308; color:#000;';
                    } else if (isCleavedTop) {
                        topStyle = 'border:2px solid #dc2626; border-radius:2px;';
                    }

                    if (isCleavedBottom && !isCutOff) {
                        botStyle = 'border:2px solid #dc2626; border-radius:2px;';
                    }

                    // Top strand visual
                    topHtml += `<span style="display:inline-block; width:12px; text-align:center; ${topStyle}">${sym.seq[b]}</span>`;

                    // Bottom strand - hide for sticky region (single stranded), gray out if cut off
                    if (isSticky) {
                        botHtml += `<span style="display:inline-block; width:12px; opacity:0.1">&nbsp;</span>`;
                    } else if (isCutOff) {
                        botHtml += `<span style="display:inline-block; width:12px; text-align:center; ${botStyle}">${sym.comp[b]}</span>`;
                    } else {
                        botHtml += `<span style="display:inline-block; width:12px; text-align:center; ${botStyle}">${sym.comp[b]}</span>`;
                    }
                }

                let containerStyle = "";
                let overlay = "";

                if (isCurrent && data.stepType !== 'binding' && data.stepType !== 'complete') {
                    overlay = `<div class="enzyme-block" style="left:${data.offset * 14}px">Sticky End</div>`;
                }

                html += `
                <div class="dna-symbol ${opacityClass}" style="${containerStyle}">
                    ${overlay}
                    <div style="font-size:10px; text-align:center; color:#64748b; margin-bottom:2px">${sym.char}</div>
                    <div class="dna-strand strand-top">${topHtml}</div>
                    <div class="dna-strand strand-bottom">${botHtml}</div>
                </div>
            `;
            });

            html += '</div>';

            // Add phase indicator BEFORE the DNA visualization
            let phaseHtml = '';
            if (data.stepType === 'binding') {
                phaseHtml = `<div class="phase-indicator"><span class="phase-badge phase-binding">üìé Binding Phase</span><span>Transition molecule ${data.transitionMolecule.id} attached</span></div>`;
            } else if (data.stepType === 'afterCut') {
                phaseHtml = `<div class="phase-indicator"><span class="phase-badge phase-aftercut">‚úÇÔ∏è After Cut</span><span>Symbol digested, new sticky end exposed</span></div>`;
            } else if (data.stepType === 'complete') {
                phaseHtml = `<div class="phase-indicator"><span class="phase-badge" style="background:#86efac;color:#166534;">‚úÖ Complete</span><span>Automaton halted</span></div>`;
            }

            canvas.innerHTML = phaseHtml + html;
        }

        function renderTransitionMolecule(molecule, symbols, symbolIndex, offset) {
            const top = molecule.top;
            const bottom = molecule.bottom;
            const fokiLen = FOKI_SITE.length; // 5
            const spacerLen = molecule.spacerLen;
            const bindingLen = 4; // Always 4 bases

            let topHtml = '';
            let botHtml = '';

            // Render top strand: [FokI: 5 bases] [Spacer: 1/3/5 bases]
            for (let i = 0; i < top.length; i++) {
                let cssClass = '';
                if (i < fokiLen) {
                    cssClass = 'foki-recognition';
                } else {
                    cssClass = 'spacer-region';
                }
                topHtml += `<span class="${cssClass}" style="display:inline-block; width:12px; text-align:center;">${top[i]}</span>`;
            }

            // Render bottom strand: [complement of FokI+spacer] [binding complement: 4 bases]
            const complementLen = bottom.length - bindingLen;
            for (let i = 0; i < bottom.length; i++) {
                let cssClass = '';
                if (i < fokiLen) {
                    cssClass = 'foki-recognition';
                } else if (i < complementLen) {
                    cssClass = 'spacer-region';
                } else {
                    cssClass = 'binding-complement';
                }
                botHtml += `<span class="${cssClass}" style="display:inline-block; width:12px; text-align:center;">${bottom[i]}</span>`;
            }

            // Calculate cut position marker
            // FokI cuts 9 bases after recognition site on 5' strand
            // The transition molecule top strand has fokiLen + spacerLen bases
            // So cut is at position: fokiLen + spacerLen + (9 - spacerLen) = fokiLen + 9 = 14... 
            // Wait, let me reconsider. The 9 bases are counted from the END of GGATG
            // So: GGATG (5) + spacer (varies) + then we count into the input DNA
            // Cut position in the input DNA region is: 9 - spacerLen - (bases already in transition molecule after GGATG)
            // For proper visualization, we show the cut on the DNA symbols, not the transition molecule

            return `
                <div class="transition-molecule">
                    <div class="transition-label">${molecule.id}: ${molecule.top.length}bp</div>
                    <div class="dna-strand strand-top" style="padding:2px;">${topHtml}</div>
                    <div class="dna-strand strand-bottom" style="padding:2px;">${botHtml}</div>
                </div>
            `;
        }

        // Initialize on load
        window.onload = function () {
            // Init with default
        };

    </script>

</body>

</html>